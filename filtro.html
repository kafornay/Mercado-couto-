<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Filtro de Melhores Pre√ßos</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    background: #f0f2f5;
    color: #333;
    line-height: 1.6;
    display: flex;
  }
  .sidebar {
    width: 260px;
    background: white;
    box-shadow: -2px 0 10px rgba(0,0,0,0.05);
    padding: 15px;
    position: fixed;
    right: 0;
    top: 0;
    bottom: 0;
    overflow-y: auto;
    transition: transform 0.3s ease;
    z-index: 1000;
  }
  .sidebar.hidden { transform: translateX(100%); }
  .sidebar h3 {
    margin-top: 0;
    font-size: 18px;
    color: #007bff;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .sidebar button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: #007bff;
  }
  .sidebar ul {
    list-style: none;
    padding: 0;
    margin-top: 10px;
  }
  .sidebar li {
    padding: 4px 0;
    border-bottom: 1px dashed #ddd;
    font-size: 14px;
  }
  .container {
    flex: 1;
    max-width: 960px;
    margin: 30px auto;
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  h2 { color: #1a2533; text-align: center; margin-bottom: 25px; font-weight: 700; }
  textarea {
    width: calc(100% - 22px);
    height: 150px;
    padding: 10px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ced4da;
    resize: vertical;
    margin-bottom: 15px;
  }
  button {
    display: inline-block;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    background: #007bff;
    color: white;
    cursor: pointer;
    font-size: 15px;
    margin: 5px;
    transition: background-color 0.2s;
  }
  button:hover { background: #0056b3; }
  #resultado, #faltando {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background: #f8f9fa;
  }
  .fornecedor {
    background: #ffffff;
    border: 1px solid #dee2e6;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .fornecedor h3 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top:0; }
  .fornecedor ul { list-style: none; padding: 0; }
  .fornecedor li {
    border-bottom: 1px dashed #ddd;
    padding: 15px 0;
  }
  .fornecedor li:last-child { border-bottom: none; }
  .fornecedor li button {
    background-color: #dc3545;
    color: white;
    padding: 6px 12px;
    font-size: 13px;
    border-radius: 4px;
  }
  .fornecedor li button:hover { background-color: #c82333; }
  .whatsapp, .pdf {
    display: inline-block;
    margin-top: 15px;
    padding: 10px 18px;
    border-radius: 20px;
    text-decoration: none;
    color: white;
    cursor: pointer;
  }
  .whatsapp { background: #25d366; }
  .whatsapp:hover { background-color: #1da851; }
  .pdf { background: #007bff; margin-left:5px; }
  .pdf:hover { background: #0056b3; }
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateY(-10px);
    animation: fadeInOut 3s ease forwards;
    z-index: 9999;
  }
  .toast.alert { background: #ffc107; color: #222; }
  @keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(-10px); }
    10%, 90% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-10px); }
  }
  #semAlternativa h3 { color: #dc3545; }
  #outrosFornecedores.hidden { display: none; }
</style>
</head>
<body>

<div class="container">
  <h2>Filtro de Melhores Pre√ßos</h2>
  <textarea id="cotacao" placeholder="Cole aqui as cota√ß√µes..."></textarea>
  <div id="listaCotacoes"></div>
  <div class="input-actions">
    <button onclick="document.getElementById('cotacao').value = ''">Limpar</button>
    <button onclick="navigator.clipboard.readText().then(text => document.getElementById('cotacao').value = text)">Colar</button>
    <button id="adicionarBtn">Adicionar Cota√ß√£o</button>
  </div>
  <hr style="margin: 20px 0;">
  <button onclick="filtrarMelhoresPrecos()">Filtrar Melhores Pre√ßos</button>
  <button onclick="verificarFaltantes()">Verificar Itens Faltantes</button>
  <div id="resultado"></div>
  <div id="faltando"></div>
  <hr>
  <div id="outrosFornecedores" class="fornecedor hidden">
    <h3>üì¶ Outros Fornecedores</h3>
    <ul id="listaOutros"></ul>
  </div>
</div>

<div class="sidebar" id="sidebar">
  <h3>üßæ Marcas Detectadas <button onclick="toggleSidebar()">üëÅÔ∏è</button></h3>
  <ul id="listaMarcas"></ul>
  <button onclick="aplicarFiltroMarcas()">Aplicar Filtro</button>
</div>

<script>
const cotacoes = [];
let todosPrecos = {};
let marcasDetectadas = new Set();
let indesejadasSet = new Set();
let historicoOriginais = {};

function normalizarTexto(txt) {
  return txt.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
function showToast(msg, tipo = 'success') {
  const toast = document.createElement('div');
  toast.className = 'toast' + (tipo === 'alert' ? ' alert' : '');
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

document.getElementById('adicionarBtn').addEventListener('click', () => {
  const texto = document.getElementById('cotacao').value.trim();
  if (!texto) return;
  cotacoes.push(texto);
  const empresa = (texto.match(/\*Empresa:\* (.+)/) || [])[1] || 'Desconhecida';
  const div = document.createElement('div');
  div.textContent = `Cota√ß√£o de: ${empresa}`;
  document.getElementById('listaCotacoes').appendChild(div);
  document.getElementById('cotacao').value = '';
  atualizarMarcasDetectadas(texto);
});

function atualizarMarcasDetectadas(texto) {
  const marcas = [...texto.matchAll(/Marca:\s*(.+)/gi)].map(m => m[1].trim());
  marcas.forEach(m => marcasDetectadas.add(m));
  renderCheckboxMarcas();
}

function renderCheckboxMarcas() {
  const lista = document.getElementById('listaMarcas');
  lista.innerHTML = '';
  [...marcasDetectadas].sort().forEach(m => {
    const li = document.createElement('li');
    li.innerHTML = `<label><input type="checkbox" value="${m}" checked> ${m}</label>`;
    lista.appendChild(li);
  });
}

function aplicarFiltroMarcas() {
  const checkboxes = document.querySelectorAll('#listaMarcas input[type="checkbox"]');
  indesejadasSet = new Set();
  checkboxes.forEach(cb => { if (!cb.checked) indesejadasSet.add(normalizarTexto(cb.value)) });
  filtrarMelhoresPrecos();
  showToast("Filtro de marcas aplicado ‚úÖ");
}

function filtrarMelhoresPrecos() {
  const precosMap = new Map();
  const fornecedoresMap = {};
  todosPrecos = {};

  cotacoes.forEach(txt => {
    const empresa = (txt.match(/\*Empresa:\* (.+)/) || [])[1] || 'Desconhecida';
    const itens = txt.split('üì¶').slice(1);
    itens.forEach(bloco => {
      const nome = (bloco.match(/\*(.+)\*/) || [])[1];
      const marca = (bloco.match(/Marca:\s*(.+)/) || [])[1];
      if (!nome || !marca) return;

      const marcaNorm = normalizarTexto(marca);
      if (indesejadasSet.has(marcaNorm)) return;

      const valor = parseFloat((bloco.match(/R\$\s*([\d,.]+)/) || ['', 'Infinity'])[1].replace(/\./g, '').replace(',', '.'));
      const qtdNaCaixaMatch = bloco.match(/(?:Qtd|Quantidade|Cont√©m):\s*(\d+)/i);
      const qtdNaCaixa = qtdNaCaixaMatch ? parseInt(qtdNaCaixaMatch[1]) : 1;

      if (!todosPrecos[nome]) todosPrecos[nome] = [];
      todosPrecos[nome].push({ empresa, valor, texto: bloco.trim(), marca, qtdNaCaixa });

      const melhor = precosMap.get(nome);
      if (!melhor || valor < melhor.valor) {
        precosMap.set(nome, { empresa, valor, texto: bloco.trim(), qtdNaCaixa });
      }
    });
  });

  for (const nome in todosPrecos) todosPrecos[nome].sort((a, b) => a.valor - b.valor);

  precosMap.forEach(({ empresa, texto, qtdNaCaixa }, nome) => {
    if (!fornecedoresMap[empresa]) fornecedoresMap[empresa] = [];
    fornecedoresMap[empresa].push({ nome, texto, qtdNaCaixa });
  });
  renderFornecedores(fornecedoresMap);
}

function renderFornecedores(map) {
  const resultado = document.getElementById('resultado');
  resultado.innerHTML = '';
  Object.entries(map).forEach(([empresa, itens]) => {
    const div = document.createElement('div');
    div.className = 'fornecedor';
    div.dataset.empresa = empresa;
    div.innerHTML = `<h3>${empresa}</h3><ul></ul>
      <a class='whatsapp' href='#' target='_blank'>Compartilhar via WhatsApp</a>
      <button class='pdf' onclick="gerarPDF('${empresa}')">üìÑ Baixar PDF</button>`;
    resultado.appendChild(div);
    itens.forEach(item => adicionarItemAoDOM(item, empresa));
    atualizarLinks(empresa);
  });
  inicializarOuLimparSemAlternativa();
}

function adicionarItemAoDOM(item, empresa, ehAlternativo = false) {
  let container = document.querySelector(`.fornecedor[data-empresa='${empresa}'] ul`);
  if (!container) return;

  const li = document.createElement('li');
  li.dataset.produto = item.nome;
  li.dataset.qtdNaCaixa = item.qtdNaCaixa;
  li.innerHTML = `
    <div class="texto-produto">${item.texto.replace(/\n/g, '<br>')}</div>
    ${ehAlternativo ? '<small style="color: #28a745;">(Alternativo)</small>' : ''}
    <div style="margin-top: 8px;">
      <label>Qtd. de caixas: </label>
      <input type="number" min="1" value="1" style="width:60px;" onchange="atualizarLinks('${empresa}')">
    </div>
    <button onclick="removerItem(this, '${empresa}','${item.nome}')" style="margin-top:8px;">Remover item</button>
  `;
  container.appendChild(li);
  atualizarLinks(empresa);
}

function removerItem(btn, empresa, nome) {
  const li = btn.closest('li');
  li.remove();
  const alternativas = todosPrecos[nome]?.filter(o => o.empresa !== empresa) || [];
  if (alternativas.length > 0) {
    const alt = alternativas[0];
    historicoOriginais[nome] = { empresaOriginal: empresa };
    adicionarItemAoDOM({ nome, texto: alt.texto, qtdNaCaixa: alt.qtdNaCaixa }, alt.empresa, true);
    showToast(`Item '${nome}' movido para fornecedor alternativo (${alt.empresa})`);
  } else {
    historicoOriginais[nome] = { empresaOriginal: empresa };
    const campo = document.getElementById('outrosFornecedores');
    campo.classList.remove('hidden');
    const lista = document.getElementById('listaOutros');
    const liNovo = document.createElement('li');
    liNovo.dataset.produto = nome;
    liNovo.innerHTML = `<div><strong>${nome}</strong><br><em>Sem fornecedor dispon√≠vel</em></div>
      <button onclick="restaurarOriginal('${nome}')">‚Ü©Ô∏è Voltar original</button>`;
    lista.appendChild(liNovo);
    showToast(`Item '${nome}' movido para "Outros Fornecedores"`, 'alert');
  }
}

function restaurarOriginal(nome) {
  const hist = historicoOriginais[nome];
  if (!hist) return;
  document.querySelectorAll(`li[data-produto="${nome}"]`).forEach(el => el.remove());
  const original = todosPrecos[nome]?.find(o => o.empresa === hist.empresaOriginal);
  if (original) {
    adicionarItemAoDOM(original, hist.empresaOriginal, false);
    showToast(`Item '${nome}' restaurado ao fornecedor original.`);
  } else {
    showToast(`Erro: fornecedor original n√£o encontrado.`, 'alert');
  }
  const outros = document.getElementById('listaOutros');
  if (outros && outros.children.length === 0) document.getElementById('outrosFornecedores').classList.add('hidden');
}

function atualizarLinks(empresa) {
  const div = document.querySelector(`.fornecedor[data-empresa='${empresa}']`);
  if (!div) return;
  const itens = div.querySelectorAll('li');
  let textoPedido = "";
  let totalGeral = 0;
  itens.forEach(li => {
    const textoOriginal = li.querySelector('.texto-produto').innerText;
    const caixasPedidas = parseInt(li.querySelector('input[type="number"]').value) || 1;
    const qtdNaCaixa = parseInt(li.dataset.qtdNaCaixa) || 1;
    const valorMatch = textoOriginal.match(/R\$\s*([\d,.]+)/);
    const valorCaixa = valorMatch ? parseFloat(valorMatch[1].replace(/\./g, '').replace(',', '.')) : 0;
    const subtotal = valorCaixa * caixasPedidas;
    const totalUnidades = qtdNaCaixa * caixasPedidas;
    totalGeral += subtotal;
    textoPedido += `üì¶ ${textoOriginal.split('\n')[0]}\nPedido: ${caixasPedidas} cx (${totalUnidades} un)\nSubtotal: R$ ${subtotal.toFixed(2)}\n\n`;
  });
  const textoFinal = `*Pedido para ${empresa}*\n\n${textoPedido}*Total geral: R$ ${totalGeral.toFixed(2)}*`;
  const link = div.querySelector('.whatsapp');
  link.href = `https://wa.me/?text=${encodeURIComponent(textoFinal)}`;
}

function inicializarOuLimparSemAlternativa() {
  let alt = document.getElementById('semAlternativa');
  const res = document.getElementById('resultado');
  if (!alt) {
    alt = document.createElement('div');
    alt.id = 'semAlternativa';
    alt.className = 'fornecedor';
    alt.innerHTML = '<h3>Itens sem Fornecedor Alternativo</h3><ul></ul>';
    alt.style.display = 'none';
    res.appendChild(alt);
  } else {
    alt.querySelector('ul').innerHTML = '';
    alt.style.display = 'none';
  }
}
</script>
</body>
</html>
