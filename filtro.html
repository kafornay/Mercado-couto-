<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Filtro de Melhores Pre√ßos</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    background: #f0f2f5;
    color: #333;
    line-height: 1.6;
  }
  .container {
    max-width: 960px;
    margin: 30px auto;
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  h2 {
    color: #1a2533;
    text-align: center;
    margin-bottom: 25px;
    font-weight: 700;
  }
  textarea {
    width: 100%;
    height: 150px;
    padding: 10px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ced4da;
    resize: vertical;
    margin-bottom: 15px;
  }
  .input-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  .input-actions button {
    background-color: #6c757d;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }
  .input-actions button:hover { background-color: #5a6268; }

  button {
    display: inline-block;
    padding: 12px 24px;
    margin: 5px;
    border: none;
    border-radius: 6px;
    background: #007bff;
    color: white;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  button:hover { background-color: #0056b3; }

  button[onclick^="filtrarMelhoresPrecos"],
  button[onclick^="verificarFaltantes"] { background-color: #28a745; }
  button[onclick^="filtrarMelhoresPrecos"]:hover,
  button[onclick^="verificarFaltantes"]:hover { background-color: #1e7e34; }

  #listaCotacoes, #resultado, #faltando {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background-color: #f8f9fa;
  }
  .item-card {
    background: #e9f7ef;
    border-left: 4px solid #28a745;
    padding: 12px 15px;
    margin-bottom: 10px;
    border-radius: 5px;
    font-size: 15px;
    color: #155724;
  }
  .fornecedor {
    background: #ffffff;
    border: 1px solid #dee2e6;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .fornecedor h3 {
    margin-top: 0;
    color: #007bff;
    margin-bottom: 15px;
    font-weight: 500;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
  }
  .fornecedor ul { padding-left: 0; list-style-type: none; }
  .fornecedor li {
    padding: 10px 0;
    border-bottom: 1px dashed #e0e0e0;
    font-size: 15px;
    line-height: 1.5;
  }
  .fornecedor li:last-child { border-bottom: none; }
  .fornecedor li button {
    background-color: #dc3545;
    color: white;
    padding: 6px 10px;
    font-size: 13px;
    margin-top: 8px;
    border-radius: 4px;
  }
  .fornecedor li button:hover { background-color: #c82333; }

  .whatsapp {
    display: inline-block;
    margin-top: 15px;
    background: #25d366;
    color: white;
    padding: 10px 18px;
    border-radius: 20px;
    text-decoration: none;
    font-size: 15px;
    font-weight: 500;
  }
  .whatsapp:hover { background-color: #1da851; }

  hr { border: none; border-top: 1px solid #dee2e6; margin: 25px 0; }

  #semAlternativa h3 { color: #dc3545; font-size: 1.1em; }
  #semAlternativa ul li { color: #555; padding: 8px 0; }
</style>
</head>
<body>
<div class="container">
  <h2>Filtro de Melhores Pre√ßos</h2>
  <textarea id="cotacao" placeholder="Cole aqui as cota√ß√µes..."></textarea>
  <div class="input-actions">
    <button onclick="document.getElementById('cotacao').value = ''">Limpar</button>
    <button onclick="navigator.clipboard.readText().then(text => document.getElementById('cotacao').value = text).catch(err => console.error(err));">Colar</button>
  </div>
  <button id="adicionarBtn">Adicionar Cota√ß√£o</button>
  <div id="listaCotacoes"></div>
  <hr />
  <button onclick="filtrarMelhoresPrecos()">Filtrar Melhores Pre√ßos</button>
  <button onclick="verificarFaltantes()">Verificar Itens Faltantes</button>
  <div id="resultado"></div>
  <div id="faltando"></div>
</div>

<script>
const cotacoes = [];
let todosPrecos = {};
let historicoOriginais = {};

document.getElementById('adicionarBtn').addEventListener('click', adicionarCotacao);

function adicionarCotacao() {
  const texto = document.getElementById('cotacao').value.trim();
  if (!texto) return;
  cotacoes.push(texto);

  const empresaMatch = texto.match(/\*Empresa:\* (.+)/);
  const nomeEmpresa = empresaMatch ? empresaMatch[1].trim() : 'Empresa n√£o identificada';

  const div = document.createElement('div');
  div.className = 'item-card';
  div.textContent = `Cota√ß√£o de: ${nomeEmpresa}`;
  document.getElementById('listaCotacoes').appendChild(div);
  document.getElementById('cotacao').value = '';
}

function filtrarMelhoresPrecos() {
  const precosMap = new Map();
  const fornecedoresMap = {};
  todosPrecos = {};

  cotacoes.forEach(txt => {
    const empresa = (txt.match(/\*Empresa:\* (.+)/) || [])[1] || 'Desconhecida';
    const itens = txt.split('üì¶').slice(1);
    itens.forEach(bloco => {
      const nome = (bloco.match(/\*(.+)\*/) || [])[1]?.toLowerCase().trim();
      if (!nome) return;
      const valor = parseFloat((bloco.match(/R\$\s*([\d,.]+)/) || ['','Infinity'])[1].replace(/\./g,'').replace(',','.'));
      if (!todosPrecos[nome]) todosPrecos[nome] = [];
      todosPrecos[nome].push({ empresa, valor, texto: bloco.trim() });

      const melhor = precosMap.get(nome);
      if (!melhor || valor < melhor.valor) precosMap.set(nome, { empresa, valor, texto: bloco.trim() });
    });
  });

  precosMap.forEach(({ empresa, texto }, nome) => {
    if (!fornecedoresMap[empresa]) fornecedoresMap[empresa] = [];
    fornecedoresMap[empresa].push({ nome, texto });
  });

  renderFornecedores(fornecedoresMap);
}

function renderFornecedores(fornecedoresMap) {
  const resultadoDiv = document.getElementById('resultado');
  resultadoDiv.innerHTML = '';

  Object.entries(fornecedoresMap).forEach(([empresa, itens]) => {
    const div = document.createElement('div');
    div.className = 'fornecedor';
    div.dataset.empresa = empresa;

    const itensHtml = itens.map(({ nome, texto }) => `
      <li data-produto="${nome.replace(/"/g,"&quot;").replace(/'/g,"&apos;")}">
        ${texto.replace(/\n/g,'<br>')}
        <br><button onclick="removerItem('${empresa.replace(/'/g,"\\'")}', '${nome.replace(/'/g,"\\'")}')">Remover item</button>
      </li>`).join('');

    div.innerHTML = `<h3>${empresa}</h3><ul>${itensHtml}</ul>`;

    const msgWhatsapp = encodeURIComponent(`Pedido ${empresa}:\n` + itens.map(i=>i.texto).join('\n\n'));
    div.innerHTML += `<a class='whatsapp' href='https://wa.me/?text=${msgWhatsapp}' target='_blank'>Compartilhar via WhatsApp</a>`;
    resultadoDiv.appendChild(div);
  });

  inicializarOuLimparSemAlternativa();
}

function inicializarOuLimparSemAlternativa() {
  let altDiv = document.getElementById('semAlternativa');
  const resultadoDiv = document.getElementById('resultado');
  if(!altDiv){
    altDiv = document.createElement('div');
    altDiv.id = 'semAlternativa';
    altDiv.className = 'fornecedor';
    altDiv.innerHTML = `<h3>Itens sem Fornecedor Alternativo</h3><ul></ul>`;
    altDiv.style.display = 'none';
    resultadoDiv.appendChild(altDiv);
  } else {
    altDiv.querySelector('ul').innerHTML = '';
    altDiv.style.display = 'none';
  }
}

function getTextFromLiForWhatsapp(liElement){
  let txt = '';
  liElement.childNodes.forEach(node=>{
    if(node.nodeName==='BUTTON') return;
    if(node.nodeName==='BR'){ txt+='\n'; return; }
    if(node.nodeType===Node.TEXT_NODE) txt+=node.textContent;
  });
  return txt.trim();
}

function removerItem(empresaOriginal, nomeProduto){
  const blocoItem = document.querySelector(`.fornecedor[data-empresa='${empresaOriginal}'] li[data-produto='${nomeProduto.replace(/"/g,"&quot;").replace(/'/g,"&apos;")}']`);
  if(!blocoItem) return;
  const fornecedorDivOriginal = blocoItem.closest('.fornecedor');
  blocoItem.remove();

  const itensRestantes = fornecedorDivOriginal.querySelectorAll('li');
  if(itensRestantes.length === 0) fornecedorDivOriginal.remove();

  const listaAlternativa = todosPrecos[nomeProduto] || [];
  const proximo = listaAlternativa.find(i=>i.empresa !== empresaOriginal);

  const semAltDiv = document.getElementById('semAlternativa');
  if(proximo){
    const divFornecedor = document.querySelector(`.fornecedor[data-empresa='${proximo.empresa}']`);
    if(divFornecedor){
      const ul = divFornecedor.querySelector('ul');
      const li = document.createElement('li');
      li.dataset.produto = nomeProduto;
      li.innerHTML = `${proximo.texto}<br><button onclick="removerItem('${proximo.empresa.replace(/'/g,"\\'")}', '${nomeProduto.replace(/'/g,"\\'")}')">Remover item</button>`;
      ul.appendChild(li);
    }
  } else {
    const ul = semAltDiv.querySelector('ul');
    const li = document.createElement('li');
    li.textContent = getTextFromLiForWhatsapp(blocoItem);
    ul.appendChild(li);
    semAltDiv.style.display='block';
  }
}

// Fun√ß√£o verificar itens faltantes
async function verificarFaltantes() {
  const faltandoDiv = document.getElementById('faltando');
  faltandoDiv.innerHTML = '<p>üîé Verificando itens faltantes...</p>';

  if (cotacoes.length === 0) {
    faltandoDiv.innerHTML = '<p style="color:red;">Nenhuma cota√ß√£o foi adicionada ainda.</p>';
    return;
  }

  const nomesCotados = new Set();
  cotacoes.forEach(txt => {
    const itens = txt.split('üì¶').slice(1);
    itens.forEach(bloco => {
      const nomeMatch = bloco.match(/\*(.+)\*/);
      if (nomeMatch) nomesCotados.add(nomeMatch[1].trim().toLowerCase());
    });
  });

  try {
    const url = "https://script.google.com/macros/s/AKfycbxLJAKDj6xrk2pZK2Kst6hGKQZO4OAXx9ZKZIzuT3Qs1Oxv1fKsbpFTQKWTLkLd7DtA7A/exec";
    const resposta = await fetch(url);
    const dados = await resposta.json();

    if (!dados || !dados.produtos) {
      faltandoDiv.innerHTML = '<p style="color:red;">N√£o foi poss√≠vel carregar a lista de produtos da planilha.</p>';
      return;
    }

    const produtosPlanilha = dados.produtos.map(p => p.toLowerCase().trim());
    const faltantes = produtosPlanilha.filter(p => !nomesCotados.has(p));

    if (faltantes.length === 0) {
      faltandoDiv.innerHTML = '<p style="color:green;">‚úÖ Nenhum item faltando! Todas as refer√™ncias foram cotadas.</p>';
    } else {
      faltandoDiv.innerHTML = `
        <h4>‚ö†Ô∏è Itens Faltantes (${faltantes.length})</h4>
        <ul style="columns:2; list-style:none; padding-left:0;">
          ${faltantes.map(f => `<li>‚Ä¢ ${f}</li>`).join('')}
        </ul>
      `;
    }
  } catch (erro) {
    console.error("Erro ao verificar itens faltantes:", erro);
    faltandoDiv.innerHTML = '<p style="color:red;">Erro ao conectar √† planilha de produtos.</p>';
  }
}
</script>
</body>
</html>
