<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Filtro de Melhores PreÃ§os â€” Corrigido</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body{font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial; margin:0; background:#f0f2f5; color:#222}
  .container{max-width:960px;margin:22px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
  h2{text-align:center;color:#1a2533;margin:0 0 14px;font-weight:700}
  textarea{width:100%;height:130px;padding:10px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;font-size:14px}
  .row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  button{background:#007bff;color:#fff;border:0;padding:10px 14px;border-radius:6px;cursor:pointer;font-weight:600}
  button.secondary{background:#6c757d}
  #listaCotacoes div{padding:8px;border-bottom:1px dashed #eee;font-size:13px}
  #resultado{margin-top:18px;padding:12px;border-radius:8px;border:1px solid #e9ecef;background:#fbfcfd}
  .produto{display:flex;justify-content:space-between;align-items:flex-start;padding:10px 0;border-bottom:1px dashed #e6e6e6}
  .produto:last-child{border-bottom:none}
  .produto-left{flex:1}
  .produto-actions{display:flex;gap:8px;align-items:center}
  .small-btn{background:#dc3545;padding:6px 9px;border-radius:6px;color:#fff;border:0;cursor:pointer}
  .hidden{display:none}
  .outros{margin-top:12px;padding:10px;border-radius:8px;border:1px solid #f0ad4e;background:#fff9f0}
  .muted{color:#666;font-size:13px}
  pre.small{background:#f7f7f7;padding:8px;border-radius:6px;overflow:auto}
</style>
</head>
<body>
  <div class="container">
    <h2>Filtro de Melhores PreÃ§os â€” Corrigido</h2>

    <label for="cotacao"><strong>Colar cotaÃ§Ã£o (formato exemplo abaixo):</strong></label>
    <pre class="small">*Empresa:* Loja A
ðŸ“¦ *Arroz*
Marca: BomGrÃ£o
Qtd: 5
Valor: R$ 50,00

ðŸ“¦ *Arroz*
Marca: Outro
Qtd: 10
Valor: R$ 45,00
</pre>

    <textarea id="cotacao" placeholder="Cole aqui as cotaÃ§Ãµes (pode colar vÃ¡rias cotaÃ§Ãµes)."></textarea>

    <div class="row" style="margin-top:10px">
      <button id="btnAdd">Adicionar CotaÃ§Ã£o</button>
      <button id="btnLimpar" class="secondary">Limpar campo</button>
      <button id="btnFiltrar" style="margin-left:auto">Filtrar Melhores PreÃ§os</button>
    </div>

    <div id="listaCotacoes" style="margin-top:12px"></div>

    <div id="resultado" class="hidden"></div>

    <div id="outrosContainer" class="outros hidden">
      <strong>Outros Fornecedores (itens sem alternativa):</strong>
      <ul id="listaOutros" style="margin:8px 0 0 14px"></ul>
    </div>
  </div>

<script>
/*
  Estrutura simples e robusta:
  - cotacoes: array raw (texto)
  - todosPrecos: { produto: [ {empresa, marca, qtd, valor, texto} ] }
  - melhor: primeiro elemento de todosPrecos[produto] (apÃ³s sort)
  - removerItem(produto, empresa): remove o fornecedor da lista, reatribui 1Âº e 2Âº
*/

const cotacoes = [];
let todosPrecos = {}; // produto -> array de ofertas ordenadas por valor asc

const el = {
  cotacao: document.getElementById('cotacao'),
  listaCotacoes: document.getElementById('listaCotacoes'),
  resultado: document.getElementById('resultado'),
  listaOutros: document.getElementById('listaOutros'),
  outrosContainer: document.getElementById('outrosContainer'),
  btnAdd: document.getElementById('btnAdd'),
  btnLimpar: document.getElementById('btnLimpar'),
  btnFiltrar: document.getElementById('btnFiltrar')
};

function normalizar(n){ return n? n.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim() : '' }

// adiciona cotaÃ§Ã£o raw
el.btnAdd.addEventListener('click', ()=>{
  const txt = el.cotacao.value.trim();
  if(!txt){ alert('Cole a cotaÃ§Ã£o antes de adicionar'); return; }
  cotacoes.push(txt);
  renderListaCotacoes();
  el.cotacao.value = '';
});

// limpar campo
el.btnLimpar.addEventListener('click', ()=> el.cotacao.value = '');

// Filtrar melhores preÃ§os (parse)
el.btnFiltrar.addEventListener('click', ()=>{
  parseCotacoes();
  renderResultado();
});

// renderiza lista simples de cotaÃ§Ãµes adicionadas
function renderListaCotacoes(){
  el.listaCotacoes.innerHTML = '';
  cotacoes.forEach((c,i)=>{
    const div = document.createElement('div');
    div.textContent = `#${i+1} â€” ${ (c.match(/\*Empresa:\*\s*(.+)/) || [])[1] || 'Desconhecida' }`;
    el.listaCotacoes.appendChild(div);
  });
}

// parse tolerante das cotaÃ§Ãµes
function parseCotacoes(){
  todosPrecos = {};
  for(const raw of cotacoes){
    const empresa = (raw.match(/\*Empresa:\*\s*(.+)/i) || [null, 'Desconhecida'])[1].trim();
    // quebrar por blocos de item (por 'ðŸ“¦' ou por linhas que iniciam com '*')
    const parts = raw.split('ðŸ“¦').slice(1);
    if(parts.length === 0){
      // fallback: procurar por padrÃµes *Nome*
      const altParts = raw.split(/\n(?=\*)/);
      altParts.forEach(block => processBlock(block, empresa));
    } else {
      parts.forEach(block => processBlock(block, empresa));
    }
  }

  // ordenar cada produto por valor asc
  Object.keys(todosPrecos).forEach(prod => {
    todosPrecos[prod].sort((a,b)=> (isFinite(a.valor)?a.valor:Infinity) - (isFinite(b.valor)?b.valor:Infinity));
  });
}

function processBlock(block, empresa){
  // tenta extrair nome entre *...*
  const nomeMatch = block.match(/\*(.+?)\*/);
  const nome = nomeMatch ? nomeMatch[1].trim() : (block.split('\n')[0]||'').trim();
  if(!nome) return;

  const marca = (block.match(/Marca:\s*([^\n\r]+)/i) || [])[1] || '';
  const qtd = (block.match(/(?:Qtd|Quantidade|ContÃ©m):\s*(\d+)/i) || [])[1] || '';
  const valorStr = (block.match(/(?:Valor|R\$):?\s*R?\$?\s*([\d\.,]+)/i) || [])[1] || (block.match(/R\$\s*([\d\.,]+)/) || [])[1] || '';
  let valor = Infinity;
  if(valorStr){
    // transformar "1.234,56" -> 1234.56 or "1234,56" -> 1234.56
    valor = parseFloat(valorStr.replace(/\./g,'').replace(',', '.')) || Infinity;
  }

  const produto = nome;
  if(!todosPrecos[produto]) todosPrecos[produto] = [];
  todosPrecos[produto].push({
    produto,
    empresa: empresa.trim(),
    marca: marca.trim(),
    qtd: qtd ? parseInt(qtd) : null,
    valor,
    texto: block.trim()
  });
}

// remover item: pega 2Âº melhor se existir, atualiza todosPrecos e renderiza
function removerItem(produto, empresa){
  if(!todosPrecos[produto]) return;
  // remove todas as ofertas deste produto desse fornecedor
  todosPrecos[produto] = todosPrecos[produto].filter(o => o.empresa !== empresa);

  if(todosPrecos[produto].length === 0){
    // nenhum fornecedor -> registrar no "outros"
    addToOutros(produto);
    delete todosPrecos[produto];
  } else {
    // jÃ¡ estÃ¡ ordenado? reordena para garantir
    todosPrecos[produto].sort((a,b)=> (a.valor||Infinity) - (b.valor||Infinity));
    // o novo melhor Ã© todosPrecos[produto][0] â€” isso jÃ¡ ocorre automaticamente
  }
  renderResultado();
}

// adiciona item na lista "outros" (sem alternativa)
function addToOutros(produto){
  const ul = el.listaOutros;
  const li = document.createElement('li');
  li.textContent = produto + ' â€” sem fornecedor alternativo';
  ul.appendChild(li);
  el.outrosContainer.classList.remove('hidden');
}

// render do resultado principal (melhor por produto)
function renderResultado(){
  el.resultado.innerHTML = '';
  // se nÃ£o tem dados
  if(Object.keys(todosPrecos).length === 0){
    el.resultado.classList.add('hidden');
    return;
  }
  el.resultado.classList.remove('hidden');

  // criar lista
  const fragment = document.createDocumentFragment();
  const title = document.createElement('h3');
  title.textContent = 'Melhores preÃ§os por produto';
  fragment.appendChild(title);

  Object.keys(todosPrecos).sort().forEach(produto => {
    const ofertas = todosPrecos[produto];
    if(!ofertas || ofertas.length === 0) return;
    const melhor = ofertas[0];

    const div = document.createElement('div');
    div.className = 'produto';

    const left = document.createElement('div');
    left.className = 'produto-left';
    left.innerHTML = `<strong>${produto}</strong>
      <div class="muted">Empresa: ${melhor.empresa} ${ melhor.marca ? ' â€” Marca: '+melhor.marca : '' }</div>
      <div style="margin-top:6px">PreÃ§o: <strong>R$ ${ isFinite(melhor.valor) ? melhor.valor.toLocaleString('pt-BR', {minimumFractionDigits:2}) : '-' }</strong></div>
      <pre class="small" style="margin:8px 0 0 0">${melhor.texto}</pre>`;

    const actions = document.createElement('div');
    actions.className = 'produto-actions';

    const removeBtn = document.createElement('button');
    removeBtn.className = 'small-btn';
    removeBtn.textContent = 'Remover (usar 2Âº)';
    // dataset para identificar
    removeBtn.dataset.produto = produto;
    removeBtn.dataset.empresa = melhor.empresa;

    actions.appendChild(removeBtn);

    // se existir segundo colocado, mostrar
    if(ofertas.length > 1){
      const segundo = ofertas[1];
      const info = document.createElement('div');
      info.style.fontSize = '13px';
      info.style.color = '#666';
      info.style.marginLeft = '12px';
      info.innerHTML = `2Âº: ${segundo.empresa} â€” R$ ${isFinite(segundo.valor) ? segundo.valor.toLocaleString('pt-BR',{minimumFractionDigits:2}) : '-'}`;
      actions.appendChild(info);
    }

    div.appendChild(left);
    div.appendChild(actions);
    fragment.appendChild(div);
  });

  el.resultado.appendChild(fragment);
}

// delegaÃ§Ã£o de evento para botÃ£o remover
el.resultado.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button.small-btn');
  if(!btn) return;
  const produto = btn.dataset.produto;
  const empresa = btn.dataset.empresa;
  if(!produto || !empresa) return;
  // antes de remover, confirmar
  const ok = confirm(`Remover ${produto} do fornecedor ${empresa}?\nSe houver 2Âº fornecedor, ele serÃ¡ escolhido automaticamente.`);
  if(!ok) return;
  removerItem(produto, empresa);
});

// impedir que o usuÃ¡rio perca dados: render inicial vazio
renderListaCotacoes();
renderResultado();

</script>
</body>
</html>
